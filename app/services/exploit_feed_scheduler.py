import logging
import asyncio
from app.services.exploit_feed_orchestrator import ExploitFeedOrchestrator
from app.utils import supabase_client

logger = logging.getLogger(__name__)


async def scheduled_exploit_feed_sync():
    """Scheduled job to fetch recent exploits from all feeds."""
    logger.info("Starting scheduled exploit feed sync...")
    orchestrator = ExploitFeedOrchestrator()
    cves_to_check = await supabase_client.get_high_priority_cves_for_exploit_check()
    tasks = [orchestrator.ingest_all_feeds(cve_id) for cve_id in cves_to_check]
    await asyncio.gather(*tasks, return_exceptions=True)
    logger.info("Exploit feed sync complete.")